<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consensus Workflow - Metrics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 40px;
            border-bottom: 1px solid #21262d;
            padding-bottom: 20px;
        }

        h1 {
            font-size: 32px;
            color: #58a6ff;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8b949e;
            font-size: 14px;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
        }

        .metric-card.highlight {
            border-color: #58a6ff;
        }

        .metric-label {
            font-size: 12px;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #58a6ff;
        }

        .metric-value.success {
            color: #3fb950;
        }

        .metric-value.warning {
            color: #d29922;
        }

        .metric-subtext {
            font-size: 12px;
            color: #8b949e;
            margin-top: 4px;
        }

        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
        }

        .chart-title {
            font-size: 16px;
            margin-bottom: 20px;
            color: #c9d1d9;
        }

        .epics-list {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            overflow: hidden;
        }

        .epic-item {
            padding: 16px 20px;
            border-bottom: 1px solid #21262d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .epic-item:last-child {
            border-bottom: none;
        }

        .epic-info h3 {
            font-size: 14px;
            margin-bottom: 4px;
            color: #c9d1d9;
        }

        .epic-meta {
            font-size: 12px;
            color: #8b949e;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .status-done {
            background: #238636;
            color: #fff;
        }

        .status-in-progress {
            background: #1f6feb;
            color: #fff;
        }

        .status-requirements,
        .status-architecture,
        .status-planning,
        .status-implementation,
        .status-testing,
        .status-deployment {
            background: #6e7681;
            color: #fff;
        }

        .epic-stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #58a6ff;
        }

        .stat-label {
            color: #8b949e;
            margin-top: 2px;
        }

        .error {
            background: #da3633;
            color: #fff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“Š Consensus Workflow Metrics</h1>
            <p class="subtitle">Real-time AI agent performance dashboard</p>
        </header>

        <div id="loading" class="loading">Loading metrics...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <!-- Summary Cards -->
            <div class="summary">
                <div class="metric-card">
                    <div class="metric-label">Total Epics</div>
                    <div class="metric-value" id="total-epics">0</div>
                </div>

                <div class="metric-card highlight">
                    <div class="metric-label">Completed</div>
                    <div class="metric-value success" id="completed-epics">0</div>
                    <div class="metric-subtext" id="completion-rate">0% success rate</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Avg Iterations</div>
                    <div class="metric-value" id="avg-iterations">0</div>
                    <div class="metric-subtext">Lower is better</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Avg Vetoes</div>
                    <div class="metric-value warning" id="avg-vetoes">0</div>
                    <div class="metric-subtext">Quality gates triggered</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Total Cost</div>
                    <div class="metric-value" id="total-cost">$0.00</div>
                    <div class="metric-subtext">AI model usage</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts">
                <div class="chart-container">
                    <div class="chart-title">Epic Status Distribution</div>
                    <canvas id="statusChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Agent Performance</div>
                    <canvas id="agentChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Iterations vs Vetoes</div>
                    <canvas id="qualityChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Cost Breakdown</div>
                    <canvas id="costChart"></canvas>
                </div>
            </div>

            <!-- Epics List -->
            <div class="chart-container">
                <div class="chart-title">Recent Epics</div>
                <div class="epics-list" id="epics-list"></div>
            </div>
        </div>
    </div>

    <script>
        let metricsData = null;

        // Load metrics
        async function loadMetrics() {
            try {
                const response = await fetch('../metrics/metrics.json');
                if (!response.ok) throw new Error('Failed to load metrics');

                metricsData = await response.json();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

                renderSummary();
                renderCharts();
                renderEpicsList();
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent =
                    'Failed to load metrics. Run: python scripts/metrics_collector.py';
                console.error(error);
            }
        }

        function renderSummary() {
            const { summary } = metricsData;

            document.getElementById('total-epics').textContent = summary.total_epics;
            document.getElementById('completed-epics').textContent = summary.completed_epics;
            document.getElementById('avg-iterations').textContent = summary.avg_iterations.toFixed(1);
            document.getElementById('avg-vetoes').textContent = summary.avg_vetoes.toFixed(1);
            document.getElementById('total-cost').textContent = `$${summary.total_cost_usd.toFixed(2)}`;

            const rate = summary.total_epics > 0
                ? (summary.completed_epics / summary.total_epics * 100).toFixed(0)
                : 0;
            document.getElementById('completion-rate').textContent = `${rate}% success rate`;
        }

        function renderCharts() {
            renderStatusChart();
            renderAgentChart();
            renderQualityChart();
            renderCostChart();
        }

        function renderStatusChart() {
            const statusCounts = {};
            metricsData.epics.forEach(epic => {
                statusCounts[epic.status] = (statusCounts[epic.status] || 0) + 1;
            });

            const ctx = document.getElementById('statusChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#238636', '#1f6feb', '#6e7681',
                            '#8957e5', '#d29922', '#da3633'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#c9d1d9' }
                        }
                    }
                }
            });
        }

        function renderAgentChart() {
            const agentCounts = {
                analyst: 0, architect: 0, tech_lead: 0,
                developer: 0, qa: 0, devops: 0
            };

            metricsData.epics.forEach(epic => {
                epic.agents_completed.forEach(agent => {
                    if (agentCounts.hasOwnProperty(agent)) {
                        agentCounts[agent]++;
                    }
                });
            });

            const ctx = document.getElementById('agentChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(agentCounts).map(a => a.replace('_', ' ')),
                    datasets: [{
                        label: 'Completed Tasks',
                        data: Object.values(agentCounts),
                        backgroundColor: '#58a6ff'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#8b949e' },
                            grid: { color: '#21262d' }
                        },
                        x: {
                            ticks: { color: '#8b949e' },
                            grid: { color: '#21262d' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#c9d1d9' }
                        }
                    }
                }
            });
        }

        function renderQualityChart() {
            const data = metricsData.epics.map(epic => ({
                x: epic.iterations,
                y: epic.total_vetoes,
                r: epic.total_cost_usd * 5 + 5
            }));

            const ctx = document.getElementById('qualityChart').getContext('2d');
            new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Epics',
                        data: data,
                        backgroundColor: 'rgba(88, 166, 255, 0.5)',
                        borderColor: '#58a6ff'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            title: { display: true, text: 'Vetoes', color: '#c9d1d9' },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#21262d' }
                        },
                        x: {
                            title: { display: true, text: 'Iterations', color: '#c9d1d9' },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#21262d' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return `Iterations: ${context.parsed.x}, Vetoes: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCostChart() {
            const costs = metricsData.epics.map(epic => epic.total_cost_usd);
            const labels = metricsData.epics.map(epic => epic.epic_id);

            const ctx = document.getElementById('costChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cost per Epic ($)',
                        data: costs,
                        borderColor: '#d29922',
                        backgroundColor: 'rgba(210, 153, 34, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#8b949e',
                                callback: (value) => '$' + value.toFixed(2)
                            },
                            grid: { color: '#21262d' }
                        },
                        x: {
                            ticks: { color: '#8b949e' },
                            grid: { color: '#21262d' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#c9d1d9' }
                        }
                    }
                }
            });
        }

        function renderEpicsList() {
            const container = document.getElementById('epics-list');
            container.innerHTML = '';

            metricsData.epics.forEach(epic => {
                const item = document.createElement('div');
                item.className = 'epic-item';

                const statusClass = `status-${epic.status.replace(' ', '-')}`;
                const statusText = epic.status.charAt(0).toUpperCase() + epic.status.slice(1);

                item.innerHTML = `
                    <div class="epic-info">
                        <h3>
                            ${epic.epic_id}: ${epic.title}
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </h3>
                        <div class="epic-meta">
                            Current: ${epic.current_agent || 'Complete'} â€¢
                            Started: ${new Date(epic.started_at).toLocaleDateString()}
                            ${epic.consensus_achieved ? ' â€¢ âœ… Consensus' : ''}
                        </div>
                    </div>
                    <div class="epic-stats">
                        <div class="stat">
                            <div class="stat-value">${epic.iterations}</div>
                            <div class="stat-label">Iterations</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${epic.total_vetoes}</div>
                            <div class="stat-label">Vetoes</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">$${epic.total_cost_usd.toFixed(2)}</div>
                            <div class="stat-label">Cost</div>
                        </div>
                    </div>
                `;

                container.appendChild(item);
            });
        }

        // Auto-refresh every 30 seconds
        setInterval(loadMetrics, 30000);

        // Initial load
        loadMetrics();
    </script>
</body>
</html>
