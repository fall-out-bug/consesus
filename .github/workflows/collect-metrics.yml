name: Collect Consensus Metrics

on:
  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
  push:
    paths:
      - 'docs/specs/*/consensus/artifacts/**'
      - 'docs/specs/*/consensus/decision_log/**'
      - 'docs/specs/*/consensus/messages/**'

  # Ð¢Ð°ÐºÐ¶Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  workflow_dispatch:

  # Ð˜ Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ
  schedule:
    - cron: '0 * * * *'

jobs:
  collect-metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run metrics collector
        run: |
          python scripts/metrics_collector.py

      - name: Upload metrics as artifact
        uses: actions/upload-artifact@v4
        with:
          name: consensus-metrics
          path: metrics/
          retention-days: 90

      - name: Commit metrics
        run: |
          git config user.name "Consensus Metrics Bot"
          git config user.email "metrics-bot@users.noreply.github.com"
          git add metrics/
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: update consensus metrics"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy dashboard to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dashboard
          publish_branch: gh-pages
          force_orphan: true

      - name: Comment on Epic Issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸
            const metricsPath = 'metrics/metrics.json';
            if (!fs.existsSync(metricsPath)) {
              console.log('No metrics file found');
              return;
            }

            const metrics = JSON.parse(fs.readFileSync(metricsPath, 'utf8'));

            // Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ epic Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ issue
            for (const epic of metrics.epics) {
              // Ð˜Ñ‰ÐµÐ¼ issue Ð¿Ð¾ epic_id Ð² title Ð¸Ð»Ð¸ labels
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'epic',
                state: 'all'
              });

              const matchingIssue = issues.data.find(issue =>
                issue.title.includes(epic.epic_id) ||
                issue.body?.includes(epic.epic_id)
              );

              if (matchingIssue) {
                // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÐºÑ€Ð°ÑÐ¸Ð²Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ñ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ°Ð¼Ð¸
                const status = epic.status === 'done' ? 'âœ…' : 'ðŸ”„';
                const consensus = epic.consensus_achieved ? 'âœ… Consensus achieved' : 'âš ï¸ Vetoes present';

                const comment = `## ${status} Epic Metrics Update

            **Status:** ${epic.status}
            **Progress:** ${epic.agents_completed.length}/6 agents completed
            **Current Agent:** ${epic.current_agent || 'Complete'}

            ### Quality Metrics
            - **Iterations:** ${epic.iterations}
            - **Vetoes:** ${epic.total_vetoes}
            - **Consensus:** ${consensus}

            ### Performance
            - **Duration:** ${(epic.total_duration_seconds / 60).toFixed(1)} minutes
            - **Cost:** $${epic.total_cost_usd.toFixed(2)}

            ### Completed Agents
            ${epic.agents_completed.map(a => `- âœ… ${a}`).join('\n')}

            ---
            ðŸ“Š [View full dashboard](https://${context.repo.owner}.github.io/${context.repo.repo}/)
            `;

                // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð»Ð¸ ÑƒÐ¶Ðµ Ñ‚Ð°ÐºÐ¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: matchingIssue.number
                });

                const existingMetricsComment = comments.data.find(c =>
                  c.body.includes('Epic Metrics Update') &&
                  c.user.login === 'github-actions[bot]'
                );

                if (existingMetricsComment) {
                  // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: existingMetricsComment.id,
                    body: comment
                  });
                } else {
                  // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: matchingIssue.number,
                    body: comment
                  });
                }
              }
            }

      - name: Create metrics summary
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ“Š Consensus Metrics Summary

          $(python3 << 'PYTHON'
          import json

          with open('metrics/metrics.json') as f:
              data = json.load(f)

          summary = data['summary']

          print(f"""
          ## Overview
          - **Total Epics:** {summary['total_epics']}
          - **Completed:** {summary['completed_epics']} âœ…
          - **In Progress:** {summary['in_progress_epics']} ðŸ”„
          - **Total Cost:** ${summary['total_cost_usd']:.2f}

          ## Quality Metrics
          - **Avg Iterations:** {summary['avg_iterations']:.1f}
          - **Avg Vetoes:** {summary['avg_vetoes']:.1f}

          ## Recent Epics
          """)

          for epic in data['epics'][:5]:
              status_icon = 'âœ…' if epic['status'] == 'done' else 'ðŸ”„'
              print(f"- {status_icon} **{epic['epic_id']}**: {epic['title']}")
              print(f"  - Status: {epic['status']}, Iterations: {epic['iterations']}, Cost: ${epic['total_cost_usd']:.2f}")

          PYTHON
          )

          ---

          [ðŸ“Š View Full Dashboard](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)
          EOF
