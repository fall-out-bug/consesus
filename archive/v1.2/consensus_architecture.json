{
  "meta": {
    "version": "1.1",
    "max_iterations": 3,
    "auto_escalate": true,
    "decision_threshold": 0.65,
    "notes": [
      "All communications live under docs/specs/<epic>/consensus/.",
      "Inbox messages are JSON with compact keys to minimise tokens."
    ]
  },
  "paths": {
    "epic": "docs/specs/{epic}/epic.md",
    "artifact_dir": "docs/specs/{epic}/consensus/artifacts",
    "messages_inbox": "docs/specs/{epic}/consensus/messages/inbox/{agent}",
    "decision_log": "docs/specs/{epic}/consensus/decision_log",
    "message_format": "{date}-{subject}.json"
  },
  "roles": {
    "analyst": {
      "mission": "Define measurable epic requirements tied to roadmap goals.",
      "artifact": "requirements.json",
      "veto": ["scope_creep", "untestable_requirement"]
    },
    "architect": {
      "mission": "Protect Clean Architecture boundaries and contracts.",
      "artifact": "architecture.json",
      "veto": ["layer_violation", "missing_contract"]
    },
    "tech_lead": {
      "mission": "Turn architecture into executable plans/tests/deploy steps.",
      "artifact": ["implementation.md", "testing.md", "deployment.md"],
      "veto": ["untestable_plan", "missing_rollback"]
    },
    "developer": {
      "mission": "Implement plan tasks with full TDD + CLI parity.",
      "artifact": "implementation.json",
      "veto": ["unclear_spec", "missing_test_spec"]
    },
    "qa": {
      "mission": "Validate acceptance criteria, coverage, and regressions.",
      "artifact": "test_results.md",
      "veto": ["failed_acceptance", "insufficient_coverage"]
    },
    "data_ml_quality": {
      "mission": "Guard DSL, datasets, grading logic, ML artifacts.",
      "artifact": "data_quality.md",
      "veto": ["dsl_break", "invalid_rubric"]
    },
    "devops": {
      "mission": "Caretake CI/CD, containers workers, secrets, environment matrices.",
      "artifact": "ci_pipeline.yaml",
      "veto": ["no_rollback_plan", "missing_health_checks"]
    },
    "sre": {
      "mission": "Define SLOs, alerts, runbooks, incident drills.",
      "artifact": "reliability.md",
      "veto": ["missing_slo", "no_runbook"]
    },
    "security": {
      "mission": "Ensure secrets, auth, and compliance controls are enforceable.",
      "artifact": "threat_model.md",
      "veto": ["critical_security_issue"]
    },
    "documentation": {
      "mission": "Keep docs/indexes current and traceable.",
      "artifact": "docs_audit.md"
    },
    "prompt_engineer": {
      "mission": "Deliver prompt packs, RAG corpora, safety evaluations.",
      "artifact": "prompts/<use_case>.md"
    },
    "support": {
      "mission": "Handle incoming user/issues, triage incidents, keep stakeholders informed.",
      "artifact": "support_runbook.md",
      "veto": ["unacknowledged_incident", "missing_communication_plan"]
    }
  },
  "iteration_flow": [
    {
      "phase": "requirements",
      "owner": "analyst",
      "steps": [
        "read(epic.md)",
        "collect_messages(analyst)",
        "emit(requirements.json)",
        "notify(architect,tech_lead)"
      ]
    },
    {
      "phase": "architecture",
      "owner": "architect",
      "steps": [
        "read(requirements.json)",
        "collect_messages(architect)",
        "emit(architecture.json,c4_diagrams.yaml)",
        "notify(tech_lead,analyst)"
      ]
    },
    {
      "phase": "planning",
      "owner": "tech_lead",
      "steps": [
        "read(requirements.json,architecture.json)",
        "emit(implementation.md,testing.md,deployment.md)",
        "notify(developer,qa,devops)"
      ]
    },
    {
      "phase": "implementation",
      "owner": "developer",
      "steps": [
        "read(plan artifacts)",
        "implement code/tests",
        "emit(implementation.json)",
        "notify(qa,tech_lead)"
      ]
    },
    {
      "phase": "validation",
      "owner": "qa",
      "steps": [
        "execute_tests",
        "emit(test_results.md)",
        "notify(devops,sre,security)"
      ]
    },
    {
      "phase": "ops",
      "owner": "devops",
      "steps": [
        "update_ci_cd",
        "emit(ci_pipeline.yaml,env_matrix.json)",
        "notify(sre,security,documentation)"
      ]
    }
  ],
  "artifacts": {
    "requirements": {
      "schema": {
        "epic_id": "string",
        "iteration": "int",
        "stories": ["string"],
        "acceptance_criteria": ["string"],
        "success_metrics": ["string"],
        "integrations": ["string"],
        "feature_flags": ["string"],
        "deferred_scope": ["string"]
      }
    },
    "architecture": {
      "schema": {
        "components": [
          {"name": "string", "layer": "domain|application|infrastructure|presentation", "ports": ["string"], "dependencies": ["string"]}
        ],
        "diagrams": ["mermaid_c4"],
        "risks": ["string"]
      }
    },
    "plan": {
      "schema": {
        "workstreams": [
          {"id": "string", "tasks": ["string"], "owner": "role"}
        ],
        "testing_matrix": ["string"],
        "deployment_steps": ["string"]
      }
    },
    "implementation": {
      "schema": {
        "tasks": [
          {"id": "string", "files": ["path"], "tests": ["command"], "status": "pending|done"}
        ],
        "evidence": ["log|artifact"]
      }
    },
    "testing": {
      "schema": {
        "scenarios": [
          {"id": "string", "type": "unit|integration|e2e|manual", "status": "pass|fail", "evidence": ["path"]}
        ],
        "coverage": {"lines": "float", "branches": "float"},
        "environment": {
          "commit": "string",
          "cli_version": "string",
          "config": "string"
        }
      }
    },
    "devops": {
      "schema": {
        "pipelines": ["string"],
        "images": ["string"],
        "cleanup": ["command"],
        "secrets": ["string"]
      }
    }
  },
  "message_schema": {
    "file_name": "{date}-{subject}.json",
    "fields": {
      "d": "YYYY-MM-DD",
      "st": "request|response|veto|handoff|status|approval",
      "r": "role",
      "epic": "EPXX",
      "sm": ["string"],
      "nx": ["string"],
      "artifacts": ["path"],
      "answers": {"id": "response"},
      "ts": "optional timestamp",
      "status": "optional approval state"
    }
  },
  "boundaries": {
    "language": "English-only across all artifacts, messages, and decision logs.",
    "message_format": "JSON with compact keys stored under docs/specs/{epic}/consensus/messages/inbox/{agent}/"
  },
  "veto_rules": {
    "scope_creep": {"authority": "analyst", "blocking": true},
    "untestable_requirement": {"authority": "analyst", "blocking": true},
    "layer_violation": {"authority": "architect", "blocking": true},
    "missing_contract": {"authority": "architect", "blocking": true},
    "untestable_plan": {"authority": "tech_lead", "blocking": true},
    "missing_rollback": {"authority": "tech_lead", "blocking": true},
    "unclear_spec": {"authority": "developer", "blocking": true},
    "insufficient_coverage": {"authority": "qa", "blocking": true},
    "dsl_break": {"authority": "data_ml_quality", "blocking": true},
    "no_rollback_plan": {"authority": "devops", "blocking": true},
    "missing_slo": {"authority": "sre", "blocking": true},
    "critical_security_issue": {"authority": "security", "blocking": true}
  },
  "automation": {
    "auto_approve": [
      "All mandatory artifacts exist and no veto raised",
      "Fix-only epics with unchanged architecture"
    ],
    "auto_escalate": [
      "Iteration >= 3 with unresolved veto",
      "Security issue marked critical",
      "Production-down risk detected"
    ]
  },
  "observability": {
    "metrics": [
      "consensus_iterations_total",
      "veto_total",
      "artifact_latency_seconds",
      "message_backlog_total"
    ],
    "logging": [
      "Every agent logs decisions to consensus/decision_log as Markdown (English-only)."
    ]
  }
}

